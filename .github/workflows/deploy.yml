name: Deploy Astro to Hostinger

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install deps
        run: npm install

      - name: Build Astro
        env:
          PUBLIC_GA_ID: ${{ secrets.PUBLIC_GA_ID }}
        run: npm run build

      - name: Deploy via FTP (retry up to 3x)
        shell: bash
        env:
          HOST: ${{ secrets.HOSTINGER_HOST }}
          USER: ${{ secrets.HOSTINGER_USER }}
          PASS: ${{ secrets.HOSTINGER_PASSWORD }}
          PORT: ${{ secrets.HOSTINGER_PORT }}
          REMOTE_PATH: ${{ secrets.HOSTINGER_PATH }}
        run: |
          set -euo pipefail
          for attempt in 1 2 3; do
            echo "FTP deploy attempt $attempt/3"
            if npx -y ftp-deploy@latest               --server "$HOST"               --username "$USER"               --password "$PASS"               --port "$PORT"               --protocol ftp               --local-dir dist/               --server-dir "$REMOTE_PATH/"; then
              echo "Deploy succeeded on attempt $attempt"
              exit 0
            fi
            if [ "$attempt" -lt 3 ]; then
              sleep 3
            fi
          done
          echo "FTP deploy failed after 3 attempts"
          exit 1
